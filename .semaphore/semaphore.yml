version: v1.0
name: Go
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Dependencies
    task:
      jobs:
        - name: Install dependencies
          commands:
            - cache restore deps-$(checksum Gopkg.lock)
            - dep ensure -v
            - cache store deps-$(checksum Gopkg.lock) vendor
      prologue:
        commands:
          - sem-version go 1.11
          - export GO111MODULE=on
          - export GOPATH=~/go
          - 'export PATH=/home/semaphore/go/bin:$PATH'
          - checkout
    dependencies: []
  - name: Linters
    dependencies:
      - Dependencies
    task:
      prologue:
        commands:
          - sem-version go 1.11
          - export GO111MODULE=on
          - export GOPATH=~/go
          - 'export PATH=/home/semaphore/go/bin:$PATH'
          - checkout
          - cache restore deps-$(checksum Gopkg.lock)
          - 'curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | BINARY=golangci-lint sh -s -- -b $(go env GOPATH)/bin v1.17.1'
      jobs:
        - name: Vet & Lint
          commands:
            - golangci-lint run --deadline 5m0s --skip-dirs=vendor/* --skip-dirs=cmd/bb-scripts/* --print-resources-usage -v --enable=misspell --enable=unconvert
  - name: Test
    dependencies:
      - Linters
    task:
      prologue:
        commands:
          - sem-version go 1.11
          - export GO111MODULE=on
          - export GOPATH=~/go
          - 'export PATH=/home/semaphore/go/bin:$PATH'
          - checkout
          - cache restore deps-$(checksum Gopkg.lock)
      epilogue:
        on_pass:
          commands:
            - 'bash <(curl -s https://codecov.io/bash) -t ${CODECOV}'
      jobs:
        - name: Unit Test of Packages
          commands:
            - go test -v -race ./...
